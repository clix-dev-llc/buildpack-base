#!/bin/bash
TIME_START=`date +%s.%N`

# Load helper functions
for file in /lib/helpers/*.bash ; do source "$file"; done

# Setup constants
source /bin/setup-env

# Read $INPUT_DIR contents from STDIN as tar.gz file
tar -xzpf - -C $INPUT_DIR 2>/dev/null

# Move stdout to desciptor 9
exec 9<&1-
# Close stderr descriptor
exec 2<&-
# Redirect stdout to the log file
exec 1<>$RUN_LOG
# Redirect stderr to the log file
exec 2>$STDERR_LOG

# Copy input files to workspace
cp -r $INPUT_DIR/. $WORKSPACE_DIR

# Copy SSH keys
cp -r /ssh/. /root/.ssh

# Run buildpack
set +e
/bin/build
RETURN_VALUE="$?"

# Normalize stderr paths (remove all parent dirs)
find-and-replace-in "$WORKSPACE_DIR/" "" $STDERR_LOG

TIME_END=`date +%s.%N`
RUNTIME=`echo "$TIME_END $TIME_START" | awk '{print $1-$2}'`
# echo "Finished in: $RUNTIME seconds"
echo $RUNTIME > $ELAPSED_LOG

# Archive output and send it to stdout
tar -czf $OUTPUT_ARCHIVE -C $OUTPUT_DIR . 2>/dev/null
# Restore stdout
exec 1<&9-
cat $OUTPUT_ARCHIVE

# Exit with buildpack's return value
exit $RETURN_VALUE
